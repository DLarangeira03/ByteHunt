@using byte_hunt.Models.Comparador
@model byte_hunt.Models.Comparador.ItemComparisonViewModel

@{
    ViewData["Title"] = "Comparação";
    <link rel="stylesheet" href="~/css/compare.css" asp-append-version="true"/>
}

<h2>Comparação</h2>

<div class="table-responsive">
    <table class="table table-bordered align-middle shadow-sm text-center" style="border-collapse: separate; border-spacing: 0 0.75rem;">
        <tbody>
        <!-- Foto -->
        <tr class="info-row" style="height: 150px;">
            <td class="text-start ps-3 fw-semibold"></td>
            @foreach (var item in Model.Items)
            {
                <td>
                    <img src="~/images/@(string.IsNullOrEmpty(item.FotoItem) ? "background_byte_hunt.svg" : item.FotoItem)"
                         alt="Foto de @item.Nome"
                         style="height: 130px; width: 100%; object-fit: contain;" />
                </td>
            }
        </tr>

        <!-- Nome -->
        <tr class="info-row">
            <td class="text-start ps-3 fw-semibold"></td>
            @foreach (var item in Model.Items)
            {
                <td class="fw-bold fs-4">@item.Nome</td>
            }
        </tr>

        <!-- Marca -->
        <tr class="info-row">
            <td class="text-start ps-3 fw-semibold"></td>
            @foreach (var item in Model.Items)
            {
                <td class="fw-normal fs-5">@item.Marca</td>
            }
        </tr>

        <!-- Spacer -->
        <tr class="info-row">
            <td colspan="@(Model.Items.Count + 1)" style="height: 1rem;"></td>
        </tr>

            <!-- Atributos -->
            @foreach (var row in Model.AttrRows)
            {
                <tr style="height: 3.5rem;">
                    <th class="bg-light text-start ps-3" style="font-size: 1.05rem; font-weight: 600;">
                        @row.Key
                    </th>
                    @for (int i = 0; i < row.Values.Count; i++)
                    {
                        var css = row.Highlights[i] switch
                        {
                            HighlightType.Best => "table-success",
                            HighlightType.Worst => "table-danger",
                            _ => ""
                        };

                        string display = FormatValue(row.Key, row.Values[i]);
                        <td class="@css text-start ps-3" style="font-size: 1rem;">
                            @display
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

@functions {
    string FormatValue(string key, string rawValue) {
        // Handle Sim/Não first
        if (rawValue.Trim().Equals("Sim", StringComparison.OrdinalIgnoreCase) ||
            rawValue.Trim().Equals("Não", StringComparison.OrdinalIgnoreCase)) {
            return rawValue;
        }

        // Try parse number
        if (!decimal.TryParse(
                rawValue.Replace(",", ".").Trim(),
                System.Globalization.NumberStyles.Number,
                System.Globalization.CultureInfo.InvariantCulture,
                out var val))
            return rawValue;

        return key switch {
            "Armazenamento" => FormatStorage(val),
            "Memória RAM" => $"{val:0.#} GB",
            "Autonomia da Bateria" => $"{val} mAh",
            "Peso" => $"{val} g",
            "Câmera" => $"{val} MP",
            "Ecrã" or "Tamanho do Ecrã" => $"{val:0.#}\"",         
            "Preço" => $"{val:0.00} €",                          
            "Tempo de Resposta" => $"{val:0.#} ms",
            "Taxa de Atualização" => $"{val:0.#} Hz",
            "Brilho" => $"{val} nits",
            "Contraste" => $"{val}",
            "Bluetooth" => $"v{val:0.#}",
            _ => $"{val:0.#}"
        };
    }

    string FormatStorage(decimal gb) {
        if (gb >= 1024)
            return $"{gb / 1024:0.#} TB";
        if (gb < 1)
            return $"{gb * 1024:0.#} MB";
        return $"{gb:0.#} GB";
    }
}